<!DOCTYPE html>
<html>
<head>
    <title>StudyBae Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='Style.css') }}">
    <link rel="icon" href="static/img/catss.gif" type="image/gif">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="logo">
            <span>Study</span><span>B</span><span>a</span><span>e</span>
        </div>
        <ul class="nav-links">
            <li><a href="{{ url_for('study_space') }}">‚Üê Back to Study Space</a></li>
        </ul>
    </nav>

    <div class="chat-container">
        <div class="chat-header">
            Messaging: <span id="currentRecipient">{{ recipient }}</span>
        </div>

        <ul id="messages">
            {% for msg in messages %}
                <li class="{% if msg.sender == username %}sender{% else %}recipient{% endif %}">
                    <span class="chat-username" onclick="replyTo('{{ msg.sender }}')">{{ msg.sender }}</span>: {{ msg.content }}
                </li>
            {% endfor %}
        </ul>

        <div class="chat-input">
            <input type="text" id="recipient" placeholder="Recipient Username" value="{{ recipient }}">
            <input type="text" id="message" placeholder="Type a message... ‚ú®">
            <button onclick="sendMessage()">Send üíå</button>
        </div>
    </div>

    <script>
        var socket = io();
        var username = "{{ username }}";

        socket.emit('join', {username: username});

        function replyTo(user) {
            document.getElementById('recipient').value = user;
            document.getElementById('recipient').dispatchEvent(new Event('input'));
            document.getElementById('message').focus();
        }

        // Keep recipient in header updated
        document.getElementById('recipient').addEventListener('input', function() {
            document.getElementById('currentRecipient').textContent = this.value;
        });

        function sendMessage() {
            var recipient = document.getElementById('recipient').value;
            var message = document.getElementById('message').value;
            if (message.trim() !== "") {
                socket.emit('send_message', {recipient: recipient, message: message});
                document.getElementById('message').value = '';
            }
        }

        socket.on('receive_message', function(data) {
            var li = document.createElement('li');
            li.className = data.sender === username ? "sender" : "recipient";
            // Make sender clickable for reply
            var nameSpan = document.createElement('span');
            nameSpan.className = "chat-username";
            nameSpan.textContent = data.sender;
            nameSpan.onclick = function() { replyTo(data.sender); };
            li.appendChild(nameSpan);
            li.appendChild(document.createTextNode(": " + data.message));
            document.getElementById('messages').appendChild(li);
        });
    </script>
</body>
</html>