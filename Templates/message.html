<!DOCTYPE html>
<html>
<head>
    <title>StudyBae Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='Style.css') }}">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="logo">
            <span>Study</span><span>B</span><span>a</span><span>e</span>
        </div>
        <ul class="nav-links">
            <li><a href="{{ url_for('profile') }}">‚Üê Back to Profile</a></li>
        </ul>
    </nav>

    <div class="chat-container">
        <div class="chat-header">
            Messaging: <span id="currentRecipient">{{ recipient }}</span>
        </div>

        <ul id="messages">
            {% for msg in messages %}
                <li class="{% if msg.sender == username %}sender{% else %}recipient{% endif %}">
                    {{ msg.sender }}: {{ msg.content }}
                    {% if msg.sender != username %}
                        <button type="button" onclick="replyTo('{{ msg.sender }}')">Reply</button>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>

        <div class="chat-input">
            <input type="text" id="recipient" placeholder="Recipient Username" value="{{ recipient }}">
            <input type="text" id="message" placeholder="Type a message... ‚ú®">
            <button onclick="sendMessage()">Send üíå</button>
        </div>
    </div>

    <script>
        var socket = io();
        var username = "{{ username }}";
        socket.emit('join', {username: username});

        document.getElementById('recipient').addEventListener('input', function() {
            document.getElementById('currentRecipient').textContent = this.value;
        });

        function replyTo(sender) {
            document.getElementById('recipient').value = sender;
            document.getElementById('recipient').dispatchEvent(new Event('input'));
            document.getElementById('message').focus();
        }

        function sendMessage() {
            var recipient = document.getElementById('recipient').value;
            var message = document.getElementById('message').value;
            if (message.trim() !== "") {
                socket.emit('send_message', {recipient: recipient, message: message});
            }
        }

        socket.on('receive_message', function(data) {
            var li = document.createElement('li');
            li.className = data.sender === username ? "sender" : "recipient";
            li.textContent = data.sender + ": " + data.message;
            if (data.sender !== username) {
                var btn = document.createElement('button');
                btn.type = "button";
                btn.textContent = "Reply";
                btn.onclick = function() { replyTo(data.sender); };
                li.appendChild(document.createTextNode(' '));
                li.appendChild(btn);
            }
            document.getElementById('messages').appendChild(li);
            document.getElementById('message').value = '';
        });
    </script>
</body>
</html>